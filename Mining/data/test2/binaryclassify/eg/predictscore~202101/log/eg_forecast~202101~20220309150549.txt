20220309-15:06:18  加载训练结果：./binaryclassify/eg/traintest~202011~202012/train_result~202011~202012.pkl
                   Out[18]: 20220309-15:06:25  <selfmodule.toolmodule.privy_outredirect.privy_Logger at 0x1a7a59dc488>
20220309-15:07:16  
                   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 预测集加工 & 预测打分过程 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
20220309-15:07:16  ---------------------------------------- 模型示例 -----------------------------------------------
20220309-15:07:17      无日数据字段进入模型
20220309-15:07:17      存在日数据字段进入用户筛选条件
20220309-15:07:17      ml.ml_feature_info_yw_user_day (20210215)
20220309-15:07:17      0行

20220309-15:07:17  condition中涉及日数据，接下来的预测过程不得不暂时忽略日数据条件
20220309-15:07:17  务必通知清单输出人员在输出清单时补充这些条件
20220309-15:07:17  确认忽略日数据条件，不会造成数据量的异常突增
20220309-15:07:17  检查剔除前后的逻辑确保可通过在清单输出时补充日数据条件以得到预期用户范围的清单

20220309-15:07:17  --- table_day从ml.ml_feature_info_yw_user_day,  acct_day, 1, 15修改为np.nan
20220309-15:07:17  --- 剔除condition_base中的日数据条件
                   原始：
                   
                       phone_no_null is null and
                       dayvalue_phone_no_null is null and
                       last_stop_date is not null and
                       innet_months >= 3
                   剔除后：
                   phone_no_null is null and
                    last_stop_date is not null and
                    innet_months >= 3

20220309-15:07:17  --- 剔除condition中的日数据条件
                   原始：
                   dayvalue_user_status='在网-正常' and 
                       phone_no_null is null and
                       dayvalue_phone_no_null is null and
                       last_stop_date is not null and
                       innet_months >= 3
                   剔除后：
                   phone_no_null is null and
                    last_stop_date is not null and
                    innet_months >= 3

20220309-15:07:17  可继续执行预测打分过程。
20220309-15:07:17  
                   ############################################################ 模型示例 ############################################################
20220309-15:07:17  日志文件：./binaryclassify/eg//predictscore~202101/log/eg_forecast~202101~20220309150717.txt
20220309-15:07:17  20220309-15:07:17  加载训练结果：./binaryclassify/eg/traintest~202011~202012/train_result~202011~202012.pkl
20220309-15:07:17  20220309-15:07:17  从训练结果中获取Info,并加入预测所需信息

20220309-15:07:17  20220309-15:07:17  condition中涉及日数据，接下来的预测过程不得不暂时忽略日数据条件
20220309-15:07:17  20220309-15:07:17  务必通知清单输出人员在输出清单时补充这些条件
20220309-15:07:17  20220309-15:07:17  确认忽略日数据条件，不会造成数据量的异常突增
20220309-15:07:17  20220309-15:07:17  检查剔除前后的逻辑确保可通过在清单输出时补充日数据条件以得到预期用户范围的清单

20220309-15:07:17  20220309-15:07:17  --- table_day从ml.ml_feature_info_yw_user_day,  acct_day, 1, 15修改为np.nan
20220309-15:07:17  20220309-15:07:17  --- 剔除condition_base中的日数据条件
                                      原始：
                                      
                                          phone_no_null is null and
                                          dayvalue_phone_no_null is null and
                                          last_stop_date is not null and
                                          innet_months >= 3
                                      剔除后：
                                      phone_no_null is null and
                                       last_stop_date is not null and
                                       innet_months >= 3

20220309-15:07:17  20220309-15:07:17  --- 剔除condition中的日数据条件
                                      原始：
                                      dayvalue_user_status='在网-正常' and 
                                          phone_no_null is null and
                                          dayvalue_phone_no_null is null and
                                          last_stop_date is not null and
                                          innet_months >= 3
                                      剔除后：
                                      phone_no_null is null and
                                       last_stop_date is not null and
                                       innet_months >= 3


                                      ###################################################################### 加工预测账期近n月基础数据
                                       
20220309-15:07:17  20220309-15:07:17  开始时间：2022-03-09 15:07:17
20220309-15:07:17  20220309-15:07:17  month: 202101
20220309-15:07:17  20220309-15:07:17  参数设置：
                                          step: predict
                                          Info.model_name: 模型示例
                                          Info.n_recent: 3
                                          drop_midtable: True
                                          cover_table_all: True

                                      ------------------------------------- 检查各前置表 --------------------------------------------------- 
20220309-15:07:17  20220309-15:07:17  检查 ml.ml_feature_info_yw_user_m
20220309-15:07:17  20220309-15:07:17      72 列
20220309-15:07:17  20220309-15:07:17      202101账期： 18000行
20220309-15:07:17  20220309-15:07:17      202012账期： 15000行
20220309-15:07:17  20220309-15:07:17      202011账期： 10000行


20220309-15:07:17  20220309-15:07:17  检查 ml.ml_feature_add_yw_user_m
20220309-15:07:17  20220309-15:07:17      4 列
20220309-15:07:17  20220309-15:07:17      202101账期： 18000行
20220309-15:07:17  20220309-15:07:17      202012账期： 15000行
20220309-15:07:17  20220309-15:07:17      202011账期： 10000行


20220309-15:07:17  20220309-15:07:17  未设置Info.table_day



20220309-15:07:17  20220309-15:07:17  预测集无需Info.table_y




                                      -------------------- 汇总当期特征与目标：ml.dm_zc_moxing_info_add_202101 -------------------------- 
20220309-15:07:17  20220309-15:07:17  查询表： 
                                          select concat(table_schema, '.', table_name) full_name
                                          from information_schema.tables 
                                          where table_schema = 'ml' and table_name='dm_zc_moxing_info_add_202101'
                                          存在1个表 
20220309-15:07:17  20220309-15:07:17  ml.dm_zc_moxing_info_add_202101已存在，将重建覆盖
20220309-15:07:17  20220309-15:07:17  建表语句： 
                                          drop table if exists ml.dm_zc_moxing_info_add_202101;
                                          select pg_sleep(10);
                                          create table ml.dm_zc_moxing_info_add_202101 as
                                          select * from (
                                              select a.* 
                                              , a2.age_add, a2.sex_add
                                              
                                              from (select * from ml.ml_feature_info_yw_user_m where cast(acct_month as text)='202101') a 
                                              left join (select*from ml.ml_feature_add_yw_user_m where cast(acct_month as text)='202101') a2 on a.user_id = a2.user_id
                                              
                                          ) t where phone_no_null is null and
                                           last_stop_date is not null and
                                           innet_months >= 3
20220309-15:07:28  20220309-15:07:28      sql执行完毕
20220309-15:07:28  20220309-15:07:28  统计 ml.dm_zc_moxing_info_add_202101 的行列数
20220309-15:07:28  20220309-15:07:28      15300行，74列
20220309-15:07:28  20220309-15:07:28          dis_predict_total {'count': 15300}

                                      ------------------------- 打分集-当月账期数据：ml.mid_eg_now_predict_202101 ---------------------------- 
20220309-15:07:28  20220309-15:07:28  建表语句（202101账期当月数据） 
                                          drop table if exists ml.mid_eg_now_predict_202101;
                                          select pg_sleep(10);
                                          create table ml.mid_eg_now_predict_202101 as 
                                          select *  from ml.dm_zc_moxing_info_add_202101
                                          where phone_no_null is null and
                                           last_stop_date is not null and
                                           innet_months >= 3
20220309-15:07:38  20220309-15:07:38      sql执行完毕
20220309-15:07:38  20220309-15:07:38  数据量： select  count(1) from ml.mid_eg_now_predict_202101
20220309-15:07:38  20220309-15:07:38      dis_predict_model {'count': 15300}


                                      ------------------------ 合并近n月数据：ml.mid_eg_recent_predict_202101  -------------------------------- 
20220309-15:07:38  20220309-15:07:38  建表语句： 
                                          drop table if exists ml.mid_eg_recent_predict_202101;
                                          select pg_sleep(10);
                                          create table ml.mid_eg_recent_predict_202101 as 
                                          select user_acct_month, data_use, acct_month, user_id, phone_no_null, account_id, innet_months, sex, last_stop_date, dinner_fee, gprs_last_defer, gprs_resource, gprs_now_rest, call_use, if_nolimit, if_5g_dinner, start_level, arpu, calling_cnt, calling_dura, calling_diff_cnt, calling_diff_dura, gprs_flow_5g, gprs_flow_busy, gprs_now_defer, gprs_flow_roam, call_dura_roam, days_gprs, days_call, nos_call, nos_calling, nos_calling_diff, sms_cnt, call_fee_local, gprs_flow_video, gprs_flow_short, gprs_flow_music, gprs_flow_commu, gprs_flow_game
                                          from (
                                              select cast(202101 as text) user_acct_month, cast('data_predict'  as text) data_use, * from ml.mid_eg_now_predict_202101
                                          ) t0
                                          union all 
                                          select user_acct_month, data_use, acct_month, user_id, phone_no_null, account_id, innet_months, sex, last_stop_date, dinner_fee, gprs_last_defer, gprs_resource, gprs_now_rest, call_use, if_nolimit, if_5g_dinner, start_level, arpu, calling_cnt, calling_dura, calling_diff_cnt, calling_diff_dura, gprs_flow_5g, gprs_flow_busy, gprs_now_defer, gprs_flow_roam, call_dura_roam, days_gprs, days_call, nos_call, nos_calling, nos_calling_diff, sms_cnt, call_fee_local, gprs_flow_video, gprs_flow_short, gprs_flow_music, gprs_flow_commu, gprs_flow_game
                                          from (
                                              select cast(202101 as text) user_acct_month, cast('data_predict'  as text) data_use, 
                                              b.* 
                                              , a2.age_add, a2.sex_add 
                                              from ml.mid_eg_now_predict_202101 a
                                              inner join (select * from ml.ml_feature_info_yw_user_m where cast(acct_month as text)='202012') b on a.user_id = b.user_id
                                              left join (select*from ml.ml_feature_add_yw_user_m where cast(acct_month as text)='202012') a2 on a.user_id = a2.user_id
                                          ) t1
                                          union all
                                          select user_acct_month, data_use, acct_month, user_id, phone_no_null, account_id, innet_months, sex, last_stop_date, dinner_fee, gprs_last_defer, gprs_resource, gprs_now_rest, call_use, if_nolimit, if_5g_dinner, start_level, arpu, calling_cnt, calling_dura, calling_diff_cnt, calling_diff_dura, gprs_flow_5g, gprs_flow_busy, gprs_now_defer, gprs_flow_roam, call_dura_roam, days_gprs, days_call, nos_call, nos_calling, nos_calling_diff, sms_cnt, call_fee_local, gprs_flow_video, gprs_flow_short, gprs_flow_music, gprs_flow_commu, gprs_flow_game
                                          from (
                                              select cast(202101 as text) user_acct_month, cast('data_predict'  as text) data_use, 
                                              b.* 
                                              , a2.age_add, a2.sex_add 
                                              from ml.mid_eg_now_predict_202101 a
                                              inner join (select * from ml.ml_feature_info_yw_user_m where cast(acct_month as text)='202011') b on a.user_id = b.user_id
                                              left join (select*from ml.ml_feature_add_yw_user_m where cast(acct_month as text)='202011') a2 on a.user_id = a2.user_id
                                          ) t2
20220309-15:07:48  20220309-15:07:48      sql执行完毕
20220309-15:07:48  20220309-15:07:48  统计ml.mid_eg_recent_predict_202101行列数
20220309-15:07:48  20220309-15:07:48      8302行，39列

                                      --------------------------------- 核验各账期数据量  -------------------------------------------------- 
20220309-15:07:48  20220309-15:07:48  sql语句： 
                                          select user_acct_month, data_use, acct_month, count(1) 
                                          from ml.mid_eg_recent_predict_202101 
                                          group by user_acct_month, data_use, acct_month 
                                          order by user_acct_month, data_use, acct_month

20220309-15:07:49  20220309-15:07:49  结果：
                                        user_acct_month      data_use  acct_month  count
                                      0          202101  data_predict      202011   8302
                                      1          202101  data_predict      202012  12655
                                      2          202101  data_predict      202101  15300




D:\STUDY\Python\PycharmProjects\ModelProject\selfmodule\tablemodule\tablefun.py:910: UserWarning: 下列账期用户量不同，请检查！
                              acct_month  count
user_acct_month data_use                       
202101          data_predict      202011   8302
                data_predict      202012  12655
                data_predict      202101  15300
  warnings.warn(w)

                                      -------------------------------- 删除中间表 ----------------------------------------------------- 
20220309-15:07:49  20220309-15:07:49  sql语句： drop table if exists ml.mid_eg_model_predict_202101
20220309-15:07:49  20220309-15:07:49      sql执行完毕
20220309-15:07:49  20220309-15:07:49  sql语句： drop table if exists ml.mid_eg_now_predict_202101
20220309-15:07:49  20220309-15:07:49      sql执行完毕

20220309-15:07:49  20220309-15:07:49  返回结果表名：ml.mid_eg_recent_predict_202101
20220309-15:07:49  20220309-15:07:49  将Info保存至./binaryclassify/eg/traintest~202011~202012/Info~base_predict.pkl

20220309-15:07:49  20220309-15:07:49  结束时间：2022-03-09 15:07:49
20220309-15:07:49  20220309-15:07:49  耗时：31 s


20220309-15:07:49  20220309-15:07:49  将数据拆分成 4 份分别预测

20220309-15:07:49  20220309-15:07:49  =========================================== 0份：[0, 1, 2] ==========================================
20220309-15:07:49  20220309-15:07:49  修改Info，用于分批预测
20220309-15:07:49  20220309-15:07:49  condition: right(user_id::text, 1) in ('0', '1', '2')
                                      table_predict:./binaryclassify/eg//predictscore~202101/predict_data~202101~0.csv
                                      table_score:./binaryclassify/eg//predictscore~202101/predict_score_data~202011~202012~202101~0.csv
20220309-15:08:04  20220309-15:08:04  ==========================================================================================

20220309-15:08:04  20220309-15:08:04  =========================================== 1份：[3, 4, 5] ==========================================
20220309-15:08:04  20220309-15:08:04  修改Info，用于分批预测
20220309-15:08:04  20220309-15:08:04  condition: right(user_id::text, 1) in ('3', '4', '5')
                                      table_predict:./binaryclassify/eg//predictscore~202101/predict_data~202101~1.csv
                                      table_score:./binaryclassify/eg//predictscore~202101/predict_score_data~202011~202012~202101~1.csv
20220309-15:08:19  20220309-15:08:19  ==========================================================================================

20220309-15:08:19  20220309-15:08:19  =========================================== 2份：[6, 7] ==========================================
20220309-15:08:19  20220309-15:08:19  修改Info，用于分批预测
20220309-15:08:19  20220309-15:08:19  condition: right(user_id::text, 1) in ('6', '7')
                                      table_predict:./binaryclassify/eg//predictscore~202101/predict_data~202101~2.csv
                                      table_score:./binaryclassify/eg//predictscore~202101/predict_score_data~202011~202012~202101~2.csv
20220309-15:08:32  20220309-15:08:32  ==========================================================================================

20220309-15:08:32  20220309-15:08:32  =========================================== 3份：[8, 9] ==========================================
20220309-15:08:32  20220309-15:08:32  修改Info，用于分批预测
20220309-15:08:32  20220309-15:08:32  condition: right(user_id::text, 1) in ('8', '9')
                                      table_predict:./binaryclassify/eg//predictscore~202101/predict_data~202101~3.csv
                                      table_score:./binaryclassify/eg//predictscore~202101/predict_score_data~202011~202012~202101~3.csv
20220309-15:08:43  20220309-15:08:43  ==========================================================================================


                                      ###################################################################### 整理分数数据
                                       
20220309-15:08:43  20220309-15:08:43  合并4个批次的分数结果
20220309-15:08:43  20220309-15:08:43      0: (4763, 23)
20220309-15:08:43  20220309-15:08:43      1: (4198, 23)
20220309-15:08:43  20220309-15:08:43      2: (3146, 23)
20220309-15:08:43  20220309-15:08:43      3: (3193, 23)
20220309-15:08:43  20220309-15:08:43  分数数据合计shape: (15300, 23)

20220309-15:08:43  20220309-15:08:43  进行分数排名与划分档位
20220309-15:08:43  20220309-15:08:43  分数档位概览：
                                          100    153
                                          99    153
                                          98    153
                                          97    153
                                          96    153
                                          95    153
                                          94    153
                                          93    153
                                          92    153
                                          91    153
                                          90    153
                                          89    153
                                          88    153
                                          87    153
                                          86    153
                                          85    153
                                          84    153
                                          83    153
                                          82    153
                                          81    153
                                          80    153
                                          79    153
                                          78    153
                                          77    153
                                          76    153
                                          75    153
                                          74    153
                                          73    153
                                          72    153
                                          71    153
                                          70    153
                                          69    153
                                          68    153
                                          67    153
                                          66    153
                                          65    153
                                          64    153
                                          63    153
                                          62    153
                                          61    153
                                          60    153
                                          59    153
                                          58    153
                                          57    153
                                          56    153
                                          55    153
                                          54    153
                                          53    153
                                          52    153
                                          51    153
                                          50    153
                                          49    153
                                          48    153
                                          47    153
                                          46    153
                                          45    153
                                          44    153
                                          43    153
                                          42    153
                                          41    153
                                          40    153
                                          39    153
                                          38    153
                                          37    153
                                          36    153
                                          35    153
                                          34    153
                                          33    153
                                          32    153
                                          31    153
                                          30    153
                                          29    153
                                          28    153
                                          27    153
                                          26    153
                                          25    153
                                          24    153
                                          23    153
                                          22    153
                                          21    153
                                          20    153
                                          19    153
                                          18    153
                                          17    153
                                          16    153
                                          15    153
                                          14    153
                                          13    153
                                          12    153
                                          11    153
                                          10    153
                                          9    153
                                          8    153
                                          7    153
                                          6    153
                                          5    153
                                          4    153
                                          3    153
                                          2    153
                                          1    153
                                          dtype: int64

20220309-15:08:43  20220309-15:08:43  保存结果数据至：./binaryclassify/eg//predictscore~202101/predict_score_data~202011~202012~202101.csv