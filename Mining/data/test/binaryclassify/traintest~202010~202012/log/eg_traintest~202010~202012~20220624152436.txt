
                   ###################################################################### 加工训练账期近n月基础数据
                    
20220624-15:24:36  开始时间：2022-06-24 15:24:36
20220624-15:24:36  ---- month: 202010
20220624-15:24:36  ---- 参数设置：
                       ---- step: train
                       ---- Info.model_name: 模型示例
                       ---- Info.n_recent: 3
                       ---- Info.Pcase_limit: 1000
                       ---- Info.traintable_ratio: 2
                       ---- Info.Pcumsum_limit: 2
                       ---- Info.timein_count: 500

                   ------------------------------------- 检查各前置表 --------------------------------------------------- 
20220624-15:24:36  检查 kehujingyingbudb.ml_xy_eg_m
20220624-15:24:36      78 列
20220624-15:24:36      202010账期： 15000行
20220624-15:24:36      202009账期： 18000行
20220624-15:24:36      202008账期： 10000行


20220624-15:24:36  正负例分布：select cast(flag_eg as text) flag_eg, count(1) from kehujingyingbudb.ml_xy_eg_m  group by flag_eg
20220624-15:24:37      dis_train_total: {'count': 68000, 'Pcount': 8036, 'prop': 0.118}



20220624-15:24:37  ---- 建表语句（限定202010账期当月目标用户）：
                       drop table if exists kehujingyingbudb.mid_eg_model_train_202010;
                       select pg_sleep(5);
                       create  table kehujingyingbudb.mid_eg_model_train_202010 as 
                       select acct_month, user_id, flag_eg ,row_number() over(order by acct_month desc, random()) rnself 
                       from kehujingyingbudb.ml_xy_eg_m
                       where acct_month>=202008 and acct_month<=202010 and user_status='在网-正常' and 
                           phone_no_null is null and
                           last_stop_date is not null and
                           innet_months >= 3 and
                           dayvalue_calling_dura>0
                        and flag_eg is not null;
20220624-15:24:42      sql执行完毕
20220624-15:24:42  统计kehujingyingbudb.mid_eg_model_train_202010行列数
20220624-15:24:42      行数：{'202009': 9625, '202010': 6238}
                       列数：4


20220624-15:24:42  ---- 建表语句（划分训练/验证数据集）：
                       drop table if exists kehujingyingbudb.mid_eg_user_train_202010;
                       create  table kehujingyingbudb.mid_eg_user_train_202010 as 
                       (select acct_month user_acct_month, 'data_timein' data_use, * from kehujingyingbudb.mid_eg_model_train_202010 where rnself <= 500)
                       union all
                       (select acct_month user_acct_month, 'data_train'  data_use, * from kehujingyingbudb.mid_eg_model_train_202010 where rnself > 500 and flag_eg=1 order by rnself limit 1000)
                       union all
                       (select acct_month user_acct_month, 'data_train'  data_use, * from kehujingyingbudb.mid_eg_model_train_202010 where rnself > 500 and flag_eg=0 order by rnself limit 2000) ;
20220624-15:24:42      sql执行完毕
20220624-15:24:42  正负例分布：select cast(flag_eg as text) flag_eg, count(1) from kehujingyingbudb.mid_eg_user_train_202010  group by flag_eg
20220624-15:24:42      dis_train_sample {'count': 3500, 'Pcount': 1091, 'prop': 0.312}



20220624-15:24:42  ---- 关联近n月数据：
                       drop table if exists kehujingyingbudb.mid_eg_recent_train_202010;
                       create  table kehujingyingbudb.mid_eg_recent_train_202010 as
                       select user_acct_month, data_use, acct_month, phone_no_null, phone_no_tm, user_id, dinner_id, account_id, innet_date, innet_months, age, sex, age_add, sex_add, user_status, last_stop_date, dinner, dinner_fee, gprs_last_defer, gprs_resource, gprs_now_rest, call_use, if_nolimit, if_5g_dinner, if_5g_term, if_jt, start_level, cred_type, if_cred_multi, arpu, pay_cnt, pay_fee, acct_balance, term_model, term_brand, term_type, sk_type, if_new_term, calling_cnt, calling_dura, called_cnt, called_dura, calling_diff_cnt, calling_diff_dura, gprs_flow, gprs_flow_4g, gprs_flow_5g, gprs_flow_busy, gprs_flow_idle, gprs_now_defer, gprs_flow_roam, call_dura_roam, days_roam, gprs_flow_gat, days_gat, days_gprs, days_call, nos_call, nos_calling, nos_calling_diff, sms_cnt, call_fee_local, call_fee_roam, gprs_income, gprs_fee, call_fee, gprs_flow_video, gprs_flow_short, gprs_flow_music, gprs_flow_commu, gprs_flow_game, dayvalue_calling_dura, dayvalue_gprs_flow, dayvalue_user_status, dayvalue_phone_no_null, flag_eg, score_flag_eg, score_flag_eg2 
                       from (
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_timein') a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202008 and acct_month<=202010) b on a.user_id = b.user_id
                       union all 
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_train' and acct_month=202008) a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202006 and acct_month<=202008) b on a.user_id = b.user_id
                       union all
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_train' and acct_month=202009) a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202007 and acct_month<=202009) b on a.user_id = b.user_id
                       union all
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_train' and acct_month=202010) a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202008 and acct_month<=202010) b on a.user_id = b.user_id
                       ) t;
20220624-15:24:43      sql执行完毕
20220624-15:24:43  统计kehujingyingbudb.mid_eg_recent_train_202010行列数
20220624-15:24:43      10372行，78列

                   --------------------------------- 核验各账期数据量  ---------------------------------------------- 
20220624-15:24:43  sql语句：
                       select user_acct_month, data_use, acct_month, flag_eg, count(1) 
                       from kehujingyingbudb.mid_eg_recent_train_202010 
                       group by user_acct_month, data_use, acct_month, flag_eg 
                       order by user_acct_month, data_use, acct_month, flag_eg

20220624-15:24:43  结果：
                       user_acct_month     data_use  acct_month  flag_eg  count
                   0            202009   data_train      202008      NaN     76
                   1            202009   data_train      202009      1.0    102
                   2            202010  data_timein      202008      NaN    500
                   3            202010  data_timein      202009      0.0    409
                   4            202010  data_timein      202009      1.0     91
                   5            202010  data_timein      202010      0.0    409
                   6            202010  data_timein      202010      1.0     91
                   7            202010   data_train      202008      NaN   2898
                   8            202010   data_train      202009      0.0   2000
                   9            202010   data_train      202009      1.0    898
                   10           202010   data_train      202010      0.0   2000
                   11           202010   data_train      202010      1.0    898


D:\工作\模型脚本\ModelProject\selfmodule\tablemodule\tablefun.py:900: UserWarning: 下列账期用户量不同，请检查！
                            acct_month  flag_eg  count
user_acct_month data_use                              
202009          data_train      202008      0.0     76
                data_train      202009      1.0    102
  warnings.warn(w); time.sleep(seconds)


D:\工作\模型脚本\ModelProject\selfmodule\tablemodule\tablefun.py:905: UserWarning: 下列账期不全（不等于3），请检查！
                            acct_month  flag_eg  count
user_acct_month data_use                              
202009          data_train      202008      0.0     76
                data_train      202009      1.0    102
  warnings.warn(w); time.sleep(seconds)
20220624-15:24:49  
                   ---- 删除中间表
20220624-15:24:49  drop table if exists kehujingyingbudb.mid_eg_model_train_202010;
20220624-15:24:49      sql执行完毕
20220624-15:24:49  drop table if exists kehujingyingbudb.mid_eg_user_train_202010;
20220624-15:24:49      sql执行完毕

20220624-15:24:49  ---- 返回结果表名：kehujingyingbudb.mid_eg_recent_train_202010
20220624-15:24:49  ---- 将Info保存至./binaryclassify/eg/traintest~202010~202012/Info~base_train.pkl

20220624-15:24:49  结束时间：2022-06-24 15:24:49
20220624-15:24:49  耗时：13 s

                   ###################################################################### 探索模型宽表
                    
20220624-15:24:49  开始时间：2022-06-24 15:24:49
20220624-15:24:49  参数设置：
                       step: train
                       table_in: kehujingyingbudb.mid_eg_recent_train_202010
                       Info.auto_pair2: False
                       Info.iv_limit: 0.05
                       stage: explore
                       Info.model_name: 模型示例
                       Info.r_limit: 0.95

20220624-15:24:49  field_base: 92行

20220624-15:24:49  删除7个available_notzd“不可用”字段：['cred_type', 'called_dura', 'days_roam', 'dayvalue_calling_dura', 'dayvalue_gprs_flow', 'dayvalue_user_status', 'dayvalue_phone_no_null']
20220624-15:24:49  field_base: 85行

20220624-15:24:49  删除1个基于“不可用”字段加工的手动衍生_py字段：
                        field_name                 formula
                   54  days_roam_p  days_roam / days_month
20220624-15:24:49  field_base: 84行
20220624-15:24:49  ------------------------- 读取数据: kehujingyingbudb.mid_eg_recent_train_202010 2022-06-24 15:24:49 -------------------------
20220624-15:24:49      src: gp
20220624-15:24:49      condition: data_use='data_train'
20220624-15:24:49      col_need(71): ['user_acct_month', 'data_use', 'acct_month', 'user_id', 'innet_months', 'age', 'age_add', 'dinner_fee', 'gprs_last_defer', 'gprs_resource', 'gprs_now_rest', 'call_use', 'arpu', 'pay_cnt', 'pay_fee', 'acct_balance', 'calling_cnt', 'calling_dura', 'called_cnt', 'calling_diff_cnt', 'calling_diff_dura', 'gprs_flow', 'gprs_flow_4g', 'gprs_flow_5g', 'gprs_flow_busy', 'gprs_flow_idle', 'gprs_now_defer', 'gprs_flow_roam', 'call_dura_roam', 'gprs_flow_gat', 'days_gat', 'days_gprs', 'days_call', 'nos_call', 'nos_calling', 'nos_calling_diff', 'sms_cnt', 'call_fee_local', 'call_fee_roam', 'gprs_income', 'gprs_fee', 'call_fee', 'gprs_flow_video', 'gprs_flow_short', 'gprs_flow_music', 'gprs_flow_commu', 'gprs_flow_game', 'score_flag_eg', 'score_flag_eg2', 'innet_date', 'last_stop_date', 'phone_no_null', 'phone_no_tm', 'dinner_id', 'account_id', 'sex', 'sex_add', 'user_status', 'dinner', 'if_nolimit', 'if_5g_dinner', 'if_5g_term', 'if_jt', 'start_level', 'if_cred_multi', 'term_model', 'term_brand', 'term_type', 'sk_type', 'if_new_term', 'flag_eg']
20220624-15:24:49      col_del: None
20220624-15:24:49      col_char(22): ['acct_month', 'phone_no_null', 'phone_no_tm', 'user_id', 'dinner_id', 'account_id', 'sex', 'sex_add', 'user_status', 'dinner', 'if_nolimit', 'if_5g_dinner', 'if_5g_term', 'if_jt', 'start_level', 'if_cred_multi', 'term_model', 'term_brand', 'term_type', 'sk_type', 'if_new_term', 'flag_eg']
20220624-15:24:49      col_num(45): ['innet_months', 'age', 'age_add', 'dinner_fee', 'gprs_last_defer', 'gprs_resource', 'gprs_now_rest', 'call_use', 'arpu', 'pay_cnt', 'pay_fee', 'acct_balance', 'calling_cnt', 'calling_dura', 'called_cnt', 'calling_diff_cnt', 'calling_diff_dura', 'gprs_flow', 'gprs_flow_4g', 'gprs_flow_5g', 'gprs_flow_busy', 'gprs_flow_idle', 'gprs_now_defer', 'gprs_flow_roam', 'call_dura_roam', 'gprs_flow_gat', 'days_gat', 'days_gprs', 'days_call', 'nos_call', 'nos_calling', 'nos_calling_diff', 'sms_cnt', 'call_fee_local', 'call_fee_roam', 'gprs_income', 'gprs_fee', 'call_fee', 'gprs_flow_video', 'gprs_flow_short', 'gprs_flow_music', 'gprs_flow_commu', 'gprs_flow_game', 'score_flag_eg', 'score_flag_eg2']
20220624-15:24:49      col_date(2): ['innet_date', 'last_stop_date']
20220624-15:24:49      nrows: None
20220624-15:24:49      if_coltolower: True
20220624-15:24:49      kwargs: {}

20220624-15:24:49      读取
20220624-15:24:52      shape: (8872, 71)

20220624-15:24:52  将score_flag_eg2字段类型(object): .astype(float)
20220624-15:24:52  -------------------------读取完毕: (8872, 71) 2022-06-24 15:24:52 -------------------------



Traceback (most recent call last):
  File "<ipython-input-3-ea15fd0e1eb8>", line 30, in <module>
    exp, Info = tab_explore_create(base_train[model_name], Info, 'explore', src)
  File "D:\工作\模型脚本\ModelProject\selfmodule\tablemodule\tablefun.py", line 1844, in tab_explore_create
    raise Exception(s)
Exception: data_recent应有下列账期数据：['202007', '202008', '202009', '202010']， 但实际：['202008', '202009', '202010']
