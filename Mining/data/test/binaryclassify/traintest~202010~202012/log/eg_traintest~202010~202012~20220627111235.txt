
                   ###################################################################### 加工训练账期近n月基础数据
                    
20220627-11:12:35  开始时间：2022-06-27 11:12:35
20220627-11:12:35  ---- month: 202010
20220627-11:12:35  ---- 参数设置：
                       ---- step: train
                       ---- Info.model_name: 模型示例
                       ---- Info.n_recent: 3
                       ---- Info.Pcase_limit: 1000
                       ---- Info.traintable_ratio: 2
                       ---- Info.Pcumsum_limit: 2
                       ---- Info.timein_count: 500

                   ------------------------------------- 检查各前置表 --------------------------------------------------- 
20220627-11:12:35  检查 kehujingyingbudb.ml_xy_eg_m
20220627-11:12:35      78 列
20220627-11:12:35      202010账期： 15000行
20220627-11:12:35      202009账期： 18000行
20220627-11:12:36      202008账期： 10000行


20220627-11:12:36  正负例分布：select cast(flag_eg as text) flag_eg, count(1) from kehujingyingbudb.ml_xy_eg_m  group by flag_eg
20220627-11:12:36      dis_train_total: {'count': 68000, 'Pcount': 8036, 'prop': 0.118}



20220627-11:12:36  ---- 建表语句（限定202010账期当月目标用户）：
                       drop table if exists kehujingyingbudb.mid_eg_model_train_202010;
                       select pg_sleep(5);
                       create  table kehujingyingbudb.mid_eg_model_train_202010 as 
                       select acct_month, user_id, flag_eg ,row_number() over(order by acct_month desc, random()) rnself 
                       from kehujingyingbudb.ml_xy_eg_m
                       where acct_month>=202008 and acct_month<=202010 and user_status='在网-正常' and 
                           phone_no_null is null and
                           last_stop_date is not null and
                           innet_months >= 3 
                        and flag_eg is not null;
20220627-11:12:41      sql执行完毕
20220627-11:12:41  统计kehujingyingbudb.mid_eg_model_train_202010行列数
20220627-11:12:42      行数：{'202009': 15048, '202010': 12449}
                       列数：4


20220627-11:12:42  ---- 建表语句（划分训练/验证数据集）：
                       drop table if exists kehujingyingbudb.mid_eg_user_train_202010;
                       create  table kehujingyingbudb.mid_eg_user_train_202010 as 
                       (select acct_month user_acct_month, 'data_timein' data_use, * from kehujingyingbudb.mid_eg_model_train_202010 where rnself <= 500)
                       union all
                       (select acct_month user_acct_month, 'data_train'  data_use, * from kehujingyingbudb.mid_eg_model_train_202010 where rnself > 500 and flag_eg=1 order by rnself limit 1000)
                       union all
                       (select acct_month user_acct_month, 'data_train'  data_use, * from kehujingyingbudb.mid_eg_model_train_202010 where rnself > 500 and flag_eg=0 order by rnself limit 2000) ;
20220627-11:12:42      sql执行完毕
20220627-11:12:42  正负例分布：select cast(flag_eg as text) flag_eg, count(1) from kehujingyingbudb.mid_eg_user_train_202010  group by flag_eg
20220627-11:12:42      dis_train_sample {'count': 3500, 'Pcount': 1079, 'prop': 0.308}



20220627-11:12:42  ---- 关联近n月数据：
                       drop table if exists kehujingyingbudb.mid_eg_recent_train_202010;
                       create  table kehujingyingbudb.mid_eg_recent_train_202010 as
                       select user_acct_month, data_use, acct_month, phone_no_null, phone_no_tm, user_id, dinner_id, account_id, innet_date, innet_months, age, sex, age_add, sex_add, user_status, last_stop_date, dinner, dinner_fee, gprs_last_defer, gprs_resource, gprs_now_rest, call_use, if_nolimit, if_5g_dinner, if_5g_term, if_jt, start_level, cred_type, if_cred_multi, arpu, pay_cnt, pay_fee, acct_balance, term_model, term_brand, term_type, sk_type, if_new_term, calling_cnt, calling_dura, called_cnt, called_dura, calling_diff_cnt, calling_diff_dura, gprs_flow, gprs_flow_4g, gprs_flow_5g, gprs_flow_busy, gprs_flow_idle, gprs_now_defer, gprs_flow_roam, call_dura_roam, days_roam, gprs_flow_gat, days_gat, days_gprs, days_call, nos_call, nos_calling, nos_calling_diff, sms_cnt, call_fee_local, call_fee_roam, gprs_income, gprs_fee, call_fee, gprs_flow_video, gprs_flow_short, gprs_flow_music, gprs_flow_commu, gprs_flow_game, dayvalue_calling_dura, dayvalue_gprs_flow, dayvalue_user_status, dayvalue_phone_no_null, flag_eg, score_flag_eg, score_flag_eg2 
                       from (
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_timein') a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202008 and acct_month<=202010) b on a.user_id = b.user_id
                       union all 
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_train' and acct_month=202008) a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202006 and acct_month<=202008) b on a.user_id = b.user_id
                       union all
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_train' and acct_month=202009) a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202007 and acct_month<=202009) b on a.user_id = b.user_id
                       union all
                       select a.user_acct_month, a.data_use, b.*
                       from (select * from kehujingyingbudb.mid_eg_user_train_202010 where data_use='data_train' and acct_month=202010) a
                       inner join (select * from kehujingyingbudb.ml_xy_eg_m where acct_month>=202008 and acct_month<=202010) b on a.user_id = b.user_id
                       ) t;
20220627-11:12:42      sql执行完毕
20220627-11:12:42  统计kehujingyingbudb.mid_eg_recent_train_202010行列数
20220627-11:12:43      9292行，78列

                   --------------------------------- 核验各账期数据量  ---------------------------------------------- 
20220627-11:12:43  sql语句：
                       select user_acct_month, data_use, acct_month, flag_eg, count(1) 
                       from kehujingyingbudb.mid_eg_recent_train_202010 
                       group by user_acct_month, data_use, acct_month, flag_eg 
                       order by user_acct_month, data_use, acct_month, flag_eg

20220627-11:12:43  结果：
                      user_acct_month     data_use  acct_month  flag_eg  count
                   0           202010  data_timein      202008      NaN    326
                   1           202010  data_timein      202009      0.0    421
                   2           202010  data_timein      202009      1.0     79
                   3           202010  data_timein      202010      0.0    421
                   4           202010  data_timein      202010      1.0     79
                   5           202010   data_train      202008      NaN   1966
                   6           202010   data_train      202009      0.0   2000
                   7           202010   data_train      202009      1.0   1000
                   8           202010   data_train      202010      0.0   2000
                   9           202010   data_train      202010      1.0   1000


D:\工作\模型脚本\ModelProject\selfmodule\tablemodule\tablefun.py:900: UserWarning: 下列账期用户量不同，请检查！
                             acct_month  flag_eg  count
user_acct_month data_use                               
202010          data_timein      202008      0.0    326
                data_timein      202009      1.0    500
                data_timein      202010      1.0    500
                data_train       202008      0.0   1966
                data_train       202009      1.0   3000
                data_train       202010      1.0   3000
  warnings.warn(w); time.sleep(seconds)
20220627-11:12:46  
                   ---- 删除中间表
20220627-11:12:46  drop table if exists kehujingyingbudb.mid_eg_model_train_202010;
20220627-11:12:46      sql执行完毕
20220627-11:12:46  drop table if exists kehujingyingbudb.mid_eg_user_train_202010;
20220627-11:12:46      sql执行完毕

20220627-11:12:46  ---- 返回结果表名：kehujingyingbudb.mid_eg_recent_train_202010
20220627-11:12:46  ---- 将Info保存至./binaryclassify/eg/traintest~202010~202012/Info~base_train.pkl

20220627-11:12:46  结束时间：2022-06-27 11:12:46
20220627-11:12:46  耗时：10 s

                   ###################################################################### 探索模型宽表
                    
20220627-11:12:46  开始时间：2022-06-27 11:12:46
20220627-11:12:46  参数设置：
                       Info.auto_pair2: False
                       step: train
                       stage: explore
                       Info.model_name: 模型示例
                       Info.r_limit: 0.95
                       table_in: kehujingyingbudb.mid_eg_recent_train_202010
                       Info.iv_limit: 0.05

20220627-11:12:46  field_base: 92行

20220627-11:12:46  删除7个available_notzd“不可用”字段：['cred_type', 'called_dura', 'days_roam', 'dayvalue_calling_dura', 'dayvalue_gprs_flow', 'dayvalue_user_status', 'dayvalue_phone_no_null']
20220627-11:12:46  field_base: 85行

20220627-11:12:46  删除1个基于“不可用”字段加工的手动衍生_py字段：
                        field_name                 formula
                   54  days_roam_p  days_roam / days_month
20220627-11:12:46  field_base: 84行
20220627-11:12:46  ------------------------- 读取数据: kehujingyingbudb.mid_eg_recent_train_202010 2022-06-27 11:12:46 -------------------------
20220627-11:12:46      src: gp
20220627-11:12:46      condition: data_use='data_train'
20220627-11:12:46      col_need(71): ['user_acct_month', 'data_use', 'acct_month', 'user_id', 'innet_months', 'age', 'age_add', 'dinner_fee', 'gprs_last_defer', 'gprs_resource', 'gprs_now_rest', 'call_use', 'arpu', 'pay_cnt', 'pay_fee', 'acct_balance', 'calling_cnt', 'calling_dura', 'called_cnt', 'calling_diff_cnt', 'calling_diff_dura', 'gprs_flow', 'gprs_flow_4g', 'gprs_flow_5g', 'gprs_flow_busy', 'gprs_flow_idle', 'gprs_now_defer', 'gprs_flow_roam', 'call_dura_roam', 'gprs_flow_gat', 'days_gat', 'days_gprs', 'days_call', 'nos_call', 'nos_calling', 'nos_calling_diff', 'sms_cnt', 'call_fee_local', 'call_fee_roam', 'gprs_income', 'gprs_fee', 'call_fee', 'gprs_flow_video', 'gprs_flow_short', 'gprs_flow_music', 'gprs_flow_commu', 'gprs_flow_game', 'score_flag_eg', 'score_flag_eg2', 'innet_date', 'last_stop_date', 'phone_no_null', 'phone_no_tm', 'dinner_id', 'account_id', 'sex', 'sex_add', 'user_status', 'dinner', 'if_nolimit', 'if_5g_dinner', 'if_5g_term', 'if_jt', 'start_level', 'if_cred_multi', 'term_model', 'term_brand', 'term_type', 'sk_type', 'if_new_term', 'flag_eg']
20220627-11:12:46      col_del: None
20220627-11:12:46      col_char(22): ['acct_month', 'phone_no_null', 'phone_no_tm', 'user_id', 'dinner_id', 'account_id', 'sex', 'sex_add', 'user_status', 'dinner', 'if_nolimit', 'if_5g_dinner', 'if_5g_term', 'if_jt', 'start_level', 'if_cred_multi', 'term_model', 'term_brand', 'term_type', 'sk_type', 'if_new_term', 'flag_eg']
20220627-11:12:46      col_num(45): ['innet_months', 'age', 'age_add', 'dinner_fee', 'gprs_last_defer', 'gprs_resource', 'gprs_now_rest', 'call_use', 'arpu', 'pay_cnt', 'pay_fee', 'acct_balance', 'calling_cnt', 'calling_dura', 'called_cnt', 'calling_diff_cnt', 'calling_diff_dura', 'gprs_flow', 'gprs_flow_4g', 'gprs_flow_5g', 'gprs_flow_busy', 'gprs_flow_idle', 'gprs_now_defer', 'gprs_flow_roam', 'call_dura_roam', 'gprs_flow_gat', 'days_gat', 'days_gprs', 'days_call', 'nos_call', 'nos_calling', 'nos_calling_diff', 'sms_cnt', 'call_fee_local', 'call_fee_roam', 'gprs_income', 'gprs_fee', 'call_fee', 'gprs_flow_video', 'gprs_flow_short', 'gprs_flow_music', 'gprs_flow_commu', 'gprs_flow_game', 'score_flag_eg', 'score_flag_eg2']
20220627-11:12:46      col_date(2): ['innet_date', 'last_stop_date']
20220627-11:12:46      nrows: None
20220627-11:12:46      if_coltolower: True
20220627-11:12:46      kwargs: {}

20220627-11:12:46      读取
20220627-11:12:52      shape: (7966, 71)

20220627-11:12:52  将score_flag_eg2字段类型(object): .astype(float)
20220627-11:12:52  -------------------------读取完毕: (7966, 71) 2022-06-27 11:12:52 -------------------------

20220627-11:12:52  手动衍生_py12个字段: {'monthsaready_last_stop_date': '最后停机时间：已发生时长', 'monthsremain_last_stop_date': '最后停机时间：剩余时长', 'days_gprs_p': '上网天数占比', 'days_call_p': '通话天数占比', 'days_call_p_1': '通话天数占比_1', 'days_call_p_2': '通话天数占比_2', 'days_call_p_3': '通话天数占比_3', 'days_call_p_4': '通话天数占比_4', 'greatest_gprs_app': 'app偏好', 'paste_dinner_innet_months': '主套餐、入网时长：交叉', 'ago_score_flag_eg': '模型示例的分数(历史)', 'ago_score_flag_eg2': '模型示例2的分数(历史)'}
20220627-11:12:52  monthsaready_last_stop_date: current_date - last_stop_date
20220627-11:12:52  monthsremain_last_stop_date: last_stop_date - current_date
20220627-11:12:53  days_gprs_p: days_gprs / days_month
20220627-11:12:53  days_call_p: days_call / days_month
20220627-11:12:53  days_call_p_1: days_call_p + days_gprs
20220627-11:12:53  days_call_p_2: days_call_p_1 + days_gprs
20220627-11:12:53  days_call_p_3: days_call_p_2 + days_gprs
20220627-11:12:53  days_call_p_4: days_call_p_3 + days_gprs
20220627-11:12:53  greatest_gprs_app: {'gprs_flow_video': 'video', 'gprs_flow_short': 'short', 'gprs_flow_music': 'music', 'gprs_flow_commu': 'commu', 'gprs_flow_game': 'game'}
20220627-11:12:57  paste_dinner_innet_months: (dinner, innet_months)
20220627-11:13:00  ago_score_flag_eg: {'notago_tovalue': 1}
20220627-11:13:00  ago_score_flag_eg2: {'notago_tovalue': 1}


Traceback (most recent call last):
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 3296, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File "<ipython-input-5-ad1d69e0e954>", line 22, in <module>
    exp, Info = tab_explore_create(base_train[model_name], Info, 'explore', src)
  File "D:\工作\模型脚本\ModelProject\selfmodule\tablemodule\tablefun.py", line 1866, in tab_explore_create
    data_recent, col_need_ad = manual_fun(data_recent, Info, field_manual)
  File "D:\工作\模型脚本\ModelProject\selfmodule\tablemodule\tablefun.py", line 1281, in manual_fun
    na_inf_examine(data_recent[field_manual.field_name])
  File "D:\工作\模型脚本\ModelProject\selfmodule\toolmodule\dataprep.py", line 142, in na_inf_examine
    raise Exception(s)
Exception: 数据存在缺失值或±inf，请检查！

缺失值：
ago_score_flag_eg2    4966
dtype: int64


Traceback (most recent call last):
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 3019, in run_cell_async
    code_ast = compiler.ast_parse(cell, filename=cell_name)
  File "D:\Python for Windows\lib\site-packages\IPython\core\compilerop.py", line 100, in ast_parse
    return compile(source, filename, symbol, self.flags | PyCF_ONLY_AST, 1)
  File "<ipython-input-6-97c12f8ef917>", line 2


Traceback (most recent call last):
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 3019, in run_cell_async
    code_ast = compiler.ast_parse(cell, filename=cell_name)
  File "D:\Python for Windows\lib\site-packages\IPython\core\compilerop.py", line 100, in ast_parse
    return compile(source, filename, symbol, self.flags | PyCF_ONLY_AST, 1)
  File "<ipython-input-6-97c12f8ef917>", line 2


Traceback (most recent call last):
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 3019, in run_cell_async
                       20220627-11:15:33  code_ast = compiler.ast_parse(cell, filename=cell_name)
  File "D:\Python for Windows\lib\site-packages\IPython\core\compilerop.py", line 100, in ast_parse
                       20220627-11:15:33  return compile(source, filename, symbol, self.flags | PyCF_ONLY_AST, 1)
  File "<ipython-input-6-97c12f8ef917>", line 2
                       
20220627-11:15:33  
                   During handling of the above exception, another exception occurred:


Traceback (most recent call last):
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 2874, in _run_cell
                       20220627-11:15:33  return runner(coro)
  File "D:\Python for Windows\lib\site-packages\IPython\core\async_helpers.py", line 67, in _pseudo_sync_runner
                       20220627-11:15:33  coro.send(None)
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 3029, in run_cell_async
                       20220627-11:15:33  self.showsyntaxerror()
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 2082, in showsyntaxerror
                       20220627-11:15:33  self._showtraceback(etype, value, stb)
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 2056, in _showtraceback
                       20220627-11:15:33  print(self.InteractiveTB.stb2text(stb))
  File "D:\工作\模型脚本\ModelProject\selfmodule\toolmodule\privy_outredirect.py", line 101, in write
                       20220627-11:15:33  self.log.write(m)
UnicodeEncodeError                   : 20220627-11:15:33  'gbk' codec can't encode character '\xeb' in position 84: illegal multibyte sequence
20220627-11:15:33  
                   During handling of the above exception, another exception occurred:


Traceback (most recent call last):
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\_pydev_bundle\pydev_code_executor.py", line 108, in add_exec
                       20220627-11:15:33  more = self.do_add_exec(code_fragment)
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\_pydev_bundle\pydev_ipython_console.py", line 36, in do_add_exec
                       20220627-11:15:33  res = bool(self.interpreter.add_exec(code_fragment.text))
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\_pydev_bundle\pydev_ipython_console_011.py", line 482, in add_exec
                       20220627-11:15:33  self.ipython.run_cell(line, store_history=True)
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 2848, in run_cell
                       20220627-11:15:33  raw_cell, store_history, silent, shell_futures)
  File "D:\Python for Windows\lib\site-packages\IPython\core\interactiveshell.py", line 2879, in _run_cell
                       20220627-11:15:33  self.showtraceback(running_compiled_code=True)
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\_pydev_bundle\pydev_ipython_console_011.py", line 188, in showtraceback
                       20220627-11:15:33  traceback.print_exception(etype, value, tb)
  File "D:\Python for Windows\lib\traceback.py", line 105, in print_exception
                       20220627-11:15:33  print(line, file=file, end="")
  File "D:\工作\模型脚本\ModelProject\selfmodule\toolmodule\privy_outredirect.py", line 101, in write
                       20220627-11:15:33  self.log.write(m)
UnicodeEncodeError                   : 20220627-11:15:33  'gbk' codec can't encode character '\xeb' in position 54: illegal multibyte sequence
20220627-11:15:33  
                   During handling of the above exception, another exception occurred:


Traceback (most recent call last):
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\pydevconsole.py", line 258, in process_exec_queue
                       20220627-11:15:33  interpreter.add_exec(code_fragment)
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\_pydev_bundle\pydev_code_executor.py", line 130, in add_exec
                       20220627-11:15:33  traceback.print_exc()
  File "D:\Python for Windows\lib\traceback.py", line 163, in print_exc
                       20220627-11:15:33  print_exception(*sys.exc_info(), limit=limit, file=file, chain=chain)
  File "D:\Python for Windows\lib\traceback.py", line 105, in print_exception
                       20220627-11:15:33  print(line, file=file, end="")
  File "D:\工作\模型脚本\ModelProject\selfmodule\toolmodule\privy_outredirect.py", line 101, in write
                       20220627-11:15:33  self.log.write(m)
UnicodeEncodeError                   : 20220627-11:15:33  'gbk' codec can't encode character '\xeb' in position 54: illegal multibyte sequence
20220627-11:15:33  
                   During handling of the above exception, another exception occurred:


Traceback (most recent call last):
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\pydevconsole.py", line 483, in <module>
                       20220627-11:15:33  pydevconsole.start_client(host, port)
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\pydevconsole.py", line 411, in start_client
                       20220627-11:15:33  process_exec_queue(interpreter)
  File "D:\Program Files\PyCharm 2021.2.2\plugins\python\helpers\pydev\pydevconsole.py", line 266, in process_exec_queue
                       20220627-11:15:33  traceback.print_exception(type, value, tb, file=sys.__stderr__)
UnboundLocalError                   : 20220627-11:15:33  local variable 'traceback' referenced before assignment
